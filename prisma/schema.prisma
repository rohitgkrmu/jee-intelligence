generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model DatasetSource {
  id          String      @id @default(cuid())
  name        String      @unique
  type        DatasetType
  description String?
  licenseInfo String?
  sourceUrl   String?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  questions   Question[]

  @@map("dataset_sources")
}

model Question {
  id              String        @id @default(cuid())
  datasetSourceId String
  examType        ExamType
  examYear        Int
  examSession     String?
  subject         Subject
  chapter         String
  topic           String
  concept         String
  questionType    QuestionType
  difficulty      Difficulty
  skills          Skill[]
  questionText    String
  options         Json?
  correctAnswer   String
  solution        String?
  isActive        Boolean       @default(true)
  tags            String[]      @default([])
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  datasetSource   DatasetSource @relation(fields: [datasetSourceId], references: [id])

  @@index([subject])
  @@index([examType, examYear])
  @@index([chapter])
  @@index([concept])
  @@index([difficulty])
  @@map("questions")
}

model DiagnosticItem {
  id              String       @id @default(cuid())
  subject         Subject
  chapter         String
  concept         String
  questionType    QuestionType
  difficulty      Difficulty
  skills          Skill[]
  questionText    String
  options         Json
  correctAnswer   String
  solution        String?
  hint            String?
  frequencyWeight Float        @default(1.0)
  priorityScore   Float        @default(1.0)
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([subject])
  @@index([difficulty])
  @@index([concept])
  @@map("diagnostic_items")
}

model DiagnosticAttempt {
  id               String        @id @default(cuid())
  leadId           String
  reportToken      String        @unique @default(cuid())
  status           AttemptStatus @default(IN_PROGRESS)
  selectedItems    String[]
  currentIndex     Int           @default(0)
  answers          Json?
  correctCount     Int           @default(0)
  incorrectCount   Int           @default(0)
  skippedCount     Int           @default(0)
  physicsScore     Float?
  chemistryScore   Float?
  mathScore        Float?
  readinessScore   Float?
  strengthConcepts String[]      @default([])
  weaknessConcepts String[]      @default([])
  totalTimeSeconds Int?
  startedAt        DateTime      @default(now())
  completedAt      DateTime?
  ipAddress        String?
  fingerprint      String?
  userAgent        String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  lead             Lead          @relation(fields: [leadId], references: [id])

  @@index([leadId])
  @@index([reportToken])
  @@index([status])
  @@map("diagnostic_attempts")
}

model Lead {
  id                 String              @id @default(cuid())
  name               String
  email              String              @unique
  phone              String?
  class              String?
  targetYear         Int?
  city               String?
  school             String?
  termsAccepted      Boolean             @default(false)
  marketingConsent   Boolean             @default(false)
  whatsappConsent    Boolean             @default(false)
  utmSource          String?
  utmMedium          String?
  utmCampaign        String?
  utmTerm            String?
  utmContent         String?
  ipAddress          String?
  fingerprint        String?
  userAgent          String?
  visitCount         Int                 @default(1)
  firstVisitAt       DateTime            @default(now())
  lastActivityAt     DateTime            @default(now())
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  diagnosticAttempts DiagnosticAttempt[]
  mockTestAttempts   MockTestAttempt[]

  @@index([email])
  @@index([createdAt])
  @@map("leads")
}

model MockTest {
  id             String            @id @default(cuid())
  name           String
  description    String?
  examType       ExamType          @default(MAIN)
  duration       Int               @default(10800) // 3 hours in seconds
  totalQuestions Int               @default(90)
  isActive       Boolean           @default(true)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  attempts       MockTestAttempt[]

  @@map("mock_tests")
}

model MockTestAttempt {
  id                 String        @id @default(cuid())
  mockTestId         String
  leadId             String
  reportToken        String        @unique @default(cuid())
  status             AttemptStatus @default(IN_PROGRESS)

  // Questions by subject (30 each)
  physicsQuestions   String[]
  chemistryQuestions String[]
  mathQuestions      String[]

  // State tracking
  answers            Json? // { questionId: { answer, timeSpent } }
  visitedQuestions   String[]      @default([])
  markedForReview    String[]      @default([])

  // Scores (calculated on submit)
  physicsScore       Int?
  chemistryScore     Int?
  mathScore          Int?
  totalScore         Int?
  correctCount       Int           @default(0)
  incorrectCount     Int           @default(0)
  unansweredCount    Int           @default(90)

  // Timing
  startedAt          DateTime      @default(now())
  completedAt        DateTime?
  totalTimeSeconds   Int?

  // Tracking
  ipAddress          String?
  fingerprint        String?

  mockTest           MockTest      @relation(fields: [mockTestId], references: [id])
  lead               Lead          @relation(fields: [leadId], references: [id])

  @@index([leadId])
  @@index([reportToken])
  @@map("mock_test_attempts")
}

model AdminUser {
  id          String    @id @default(cuid())
  email       String    @unique
  password    String
  name        String
  role        AdminRole @default(EDITOR)
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("admin_users")
}

model RateLimitEntry {
  id           String   @id @default(cuid())
  identifier   String
  endpoint     String
  requestCount Int      @default(1)
  windowStart  DateTime @default(now())

  @@unique([identifier, endpoint])
  @@index([windowStart])
  @@map("rate_limit_entries")
}

enum DatasetType {
  LICENSED
  OWNED
  PUBLIC
}

enum ExamType {
  MAIN
  ADVANCED
}

enum Subject {
  PHYSICS
  CHEMISTRY
  MATHEMATICS
}

enum QuestionType {
  MCQ_SINGLE
  MCQ_MULTIPLE
  NUMERICAL
  INTEGER
  MATCH_THE_COLUMN
  ASSERTION_REASON
  COMPREHENSION
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum Skill {
  CONCEPTUAL
  NUMERICAL
  APPLICATION
  ANALYTICAL
  DERIVATION
  GRAPHICAL
}

enum AttemptStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  EDITOR
  VIEWER
}
